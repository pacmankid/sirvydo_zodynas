<script>
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('userQuestion');
    const sendBtn = document.getElementById('sendBtn');
    const toggleTheme = document.getElementById('toggleTheme');

    /* DARK MODE */
    toggleTheme.addEventListener('click', () =>
        document.documentElement.classList.toggle('dark')
    );

    /* ADD MESSAGE */
    function addMessage(text, sender = "bot") {
        const wrap = document.createElement("div");
        wrap.className = `flex items-start gap-3 max-w-[85%] ${sender === "user" ? "ml-auto flex-row-reverse" : ""}`;

        const avatar = document.createElement("div");
        avatar.className = "w-10 h-10 rounded-full flex-shrink-0 overflow-hidden";

        if (sender === "user") {
            avatar.innerHTML = `<div class='w-full h-full bg-gray-500 text-white flex items-center justify-center font-bold'>ğŸ‘¤</div>`;
        } else {
            avatar.innerHTML = `<img src="https://lndm.lt/wp-content/uploads/2019/08/pro-vg_kss_dgobj_6271536624770493993.jpg" class="w-full h-full object-cover">`;
        }

        const bubble = document.createElement("div");
        bubble.className = `
            p-3 rounded-xl text-sm leading-relaxed shadow
            ${sender === "user" ? "bg-primary text-white" : "bg-gray-200 dark:bg-msgBot"}
        `;

        // PaverÄiame atsakymÄ… Ä¯ pastraipas <p> elementais
        const paragraphs = text.split(/\n+/).filter(line => line.trim() !== "");
        bubble.innerHTML = paragraphs.map(p => `<p class="mb-2">${p}</p>`).join("");

        wrap.appendChild(avatar);
        wrap.appendChild(bubble);
        chatbox.appendChild(wrap);

        chatbox.scrollTop = chatbox.scrollHeight;
    }

    /* SEND MESSAGE */
    async function sendMessage() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const question = userInput.value.trim();

        if (!apiKey || !question) {
            alert("Ä®veskite API raktÄ… ir klausimÄ…");
            return;
        }

        addMessage(question, "user");
        userInput.value = "";

        // Typing indicator
        const typing = document.createElement("div");
        typing.id = "typing";
        typing.className = "text-gray-500 dark:text-gray-400 text-sm italic";
        typing.textContent = "Sirvydas mÄ…sto...";
        chatbox.appendChild(typing);
        chatbox.scrollTop = chatbox.scrollHeight;

        try {
            const firstMessage = !sessionStorage.getItem("sirvydasGreeted");

            const response = await fetch("/api/chatbot", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ apiKey, prompt: question, firstMessage })
            });

            const data = await response.json();
            const answer = data.answer || "Ä®vyko klaida.";

            typing.remove();
            addMessage(answer, "bot");

            if (firstMessage) sessionStorage.setItem("sirvydasGreeted", "true");

        } catch {
            typing.remove();
            addMessage("Ä®vyko klaida.", "bot");
        }
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
    });
</script>
