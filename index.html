<!DOCTYPE html>
<html lang="lt" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sirvydo Å½odynas â€“ Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col">

<div class="flex flex-1 h-screen max-w-5xl mx-auto w-full">

    <!-- CHAT + INPUT AREA -->
    <div class="flex-1 flex flex-col">

        <!-- API INPUT -->
        <div class="p-3">
            <label class="text-sm mb-1 block">Ä®veskite DI API raktÄ…:</label>
            <input type="text" id="apiKey" placeholder="API raktas" class="w-full p-3 rounded-lg bg-gray-700 text-gray-100 focus:outline-none">
        </div>

        <!-- CHAT WINDOW -->
        <div id="chatbox" class="flex-1 overflow-y-auto p-4 space-y-4" style="height: calc(100vh - 130px);"></div>

        <!-- INPUT BAR FIXED BOTTOM -->
        <div class="p-3 bg-gray-800 border-t border-gray-700 flex items-center gap-2">
            <input id="userQuestion" type="text" placeholder="RaÅ¡ykite klausimÄ…â€¦" class="flex-1 p-3 rounded-lg bg-gray-700 text-gray-100 focus:outline-none">
            <button id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-lg">SiÅ³sti</button>
        </div>
    </div>

    <!-- SIDEBAR ISTORIJA -->
    <div class="w-64 bg-gray-800 border-l border-gray-700 p-3 hidden lg:flex flex-col">
        <h2 class="text-lg font-bold mb-3">IeÅ¡kotÅ³ Å¾odÅ¾iÅ³ istorija</h2>
        <div id="historyList" class="flex-1 overflow-y-auto space-y-2"></div>
    </div>
</div>

<script>
    const chatbox = document.getElementById("chatbox");
    const userInput = document.getElementById("userQuestion");
    const sendBtn = document.getElementById("sendBtn");
    const apiKeyInput = document.getElementById("apiKey");
    const historyList = document.getElementById("historyList");

    // ISTORIJOS IÅ SAUGOJIMAS CHAT + WORDS
    function saveHistory() {
        localStorage.setItem("sirvydas_history", chatbox.innerHTML);
        const words = Array.from(historyList.children).map(el => el.textContent);
        localStorage.setItem("sirvydas_words", JSON.stringify(words));
    }

    function loadHistory() {
        const history = localStorage.getItem("sirvydas_history");
        if (history) chatbox.innerHTML = history;

        const words = JSON.parse(localStorage.getItem("sirvydas_words") || '[]');
        words.forEach(word => {
            const el = document.createElement('div');
            el.className = 'p-2 bg-gray-700 rounded text-sm cursor-pointer hover:bg-gray-600';
            el.textContent = word;
            historyList.appendChild(el);
        });
    }
    loadHistory();

    async function typeWriterEffect(element, text, speed = 15) {
        for (let i = 0; i < text.length; i++) {
            element.innerHTML += text[i];
            await new Promise(res => setTimeout(res, speed));
        }
    }

    function addMessage(text, sender) {
        const wrapper = document.createElement("div");
        wrapper.className = `flex items-start gap-3 ${sender === 'user' ? 'justify-end' : ''}`;

        const avatar = document.createElement("div");
        avatar.className = "w-10 h-10 rounded-full overflow-hidden flex-shrink-0";
        if (sender === 'user') {
            avatar.innerHTML = `<div class='w-full h-full bg-blue-600 text-white flex items-center justify-center rounded-full'>ðŸ§‘</div>`;
        } else {
            avatar.innerHTML = `<img src='https://upload.wikimedia.org/wikipedia/commons/4/43/Konstanty_Szyrwid.PNG' class='w-full h-full object-cover'>`;
        }

        const bubble = document.createElement("div");
        bubble.className = `max-w-[75%] p-3 rounded-xl shadow-md leading-relaxed ${sender === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-100 rounded-bl-none'}`;

        if (sender === 'user') {
            wrapper.appendChild(bubble);
            wrapper.appendChild(avatar);
            bubble.textContent = text;
            chatbox.appendChild(wrapper);

            // Ä®raÅ¡o Ä¯ Å¾odÅ¾iÅ³ istorijÄ…
            const el = document.createElement('div');
            el.className = 'p-2 bg-gray-700 rounded text-sm cursor-pointer hover:bg-gray-600';
            el.textContent = text;
            historyList.appendChild(el);

            chatbox.scrollTop = chatbox.scrollHeight;
            saveHistory();
            return;
        }

        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);
        chatbox.appendChild(wrapper);
        chatbox.scrollTop = chatbox.scrollHeight;
        typeWriterEffect(bubble, text).then(saveHistory);
    }

    async function sendMessage() {
        const question = userInput.value.trim();
        const apiKey = apiKeyInput.value.trim();
        if (!question || !apiKey) {
            alert("Ä®veskite API raktÄ… ir klausimÄ…");
            return;
        }

        addMessage(question, "user");
        userInput.value = "";

        addMessage("â€¦", "bot");

        try {
            const response = await fetch("/api/chatbot", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ apiKey, prompt: question })
            });

            const data = await response.json();
            const last = chatbox.lastChild.querySelector('div:nth-child(2)');
            last.innerHTML = "";
            if (!data.answer) {
                typeWriterEffect(last, "âš  Ä®vyko klaida. Patikrinkite API atsakymÄ….");
                return;
            }
            typeWriterEffect(last, data.answer);
        } catch (err) {
            console.error(err);
            const last = chatbox.lastChild.querySelector('div:nth-child(2)');
            last.innerHTML = "";
            typeWriterEffect(last, "âš  Nepavyko susisiekti su serveriu.");
        }
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
    });
</script>
</body>
</html>
