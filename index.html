<!DOCTYPE html>
<html lang="lt" class="dark">
<head>
    <meta charset="UTF-8" />
    <title>Sirvydo Å¾odynas â€¢ Chatbot</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: "#0079ff",
                        bgLight: "#f5f7fa",
                        bgDark: "#1e1f24",
                        msgBot: "#32343a"
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-bgLight dark:bg-bgDark text-gray-900 dark:text-gray-100 transition-colors duration-300">

<div class="max-w-3xl mx-auto h-screen flex flex-col p-4">

    <!-- HEADER -->
    <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">Sirvydo Å¾odynas â€¢ Chatbot</h1>
        <button id="toggleTheme"
            class="px-3 py-1 rounded-lg bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
            ğŸŒ™ / â˜€ï¸
        </button>
    </div>

    <!-- API INPUT -->
    <label class="text-sm">Ä®veskite savo DI API raktÄ…:</label>
    <input type="text" id="apiKey"
        class="w-full p-2 rounded-lg border dark:border-gray-700 bg-white dark:bg-gray-800 mb-2"
        placeholder="API raktas">

    <!-- CHATBOX -->
    <div id="chatbox"
        class="flex-1 overflow-y-auto bg-white dark:bg-gray-800 rounded-xl p-4 shadow-inner flex flex-col gap-4">
    </div>

    <!-- INPUT BAR -->
    <div class="flex mt-3 gap-2">
        <input type="text" id="userQuestion"
            class="flex-1 p-3 rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-900"
            placeholder="Ä®veskite klausimÄ…...">

        <button id="sendBtn"
            class="px-5 py-3 bg-primary text-white rounded-xl hover:bg-blue-600 transition">
            SiÅ³sti
        </button>
    </div>

</div>

<script>
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('userQuestion');
    const sendBtn = document.getElementById('sendBtn');
    const toggleTheme = document.getElementById('toggleTheme');

    let firstMessage = true; // seka, ar tai pirmas klausimas sesijoje

    /* DARK MODE */
    toggleTheme.addEventListener('click', () =>
        document.documentElement.classList.toggle('dark')
    );

    /* ADD MESSAGE */
    function addMessage(text, sender = "bot") {
        const wrap = document.createElement("div");
        wrap.className = `flex items-start gap-3 max-w-[85%] ${sender === "user" ? "ml-auto flex-row-reverse" : ""}`;

        const avatar = document.createElement("div");
        avatar.className = "w-10 h-10 rounded-full flex-shrink-0 overflow-hidden";

        if (sender === "user") {
            avatar.innerHTML = `<div class='w-full h-full bg-gray-500 text-white flex items-center justify-center font-bold'>ğŸ‘¤</div>`;
        } else {
            avatar.innerHTML = `<img src="https://lndm.lt/wp-content/uploads/2019/08/pro-vg_kss_dgobj_6271536624770493993.jpg" class="w-full h-full object-cover">`;
        }

        const bubble = document.createElement("div");
        bubble.className = `
            p-3 rounded-xl text-sm leading-relaxed shadow
            ${sender === "user" ? "bg-primary text-white" : "bg-gray-200 dark:bg-msgBot"}
        `;
        bubble.textContent = text;

        wrap.appendChild(avatar);
        wrap.appendChild(bubble);
        chatbox.appendChild(wrap);

        chatbox.scrollTop = chatbox.scrollHeight;
    }

    /* SEND MESSAGE */
    async function sendMessage() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const question = userInput.value.trim();

        if (!apiKey || !question) {
            alert("Ä®veskite API raktÄ… ir klausimÄ…");
            return;
        }

        addMessage(question, "user");
        userInput.value = "";

        const typing = document.createElement("div");
        typing.id = "typing";
        typing.className = "text-gray-500 dark:text-gray-400 text-sm italic";
        typing.textContent = "Sirvydas mÄ…sto...";
        chatbox.appendChild(typing);
        chatbox.scrollTop = chatbox.scrollHeight;

        try {
            const response = await fetch("/api/chatbot", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-first-message": firstMessage ? "true" : "false"
                },
                body: JSON.stringify({ apiKey, prompt: question })
            });

            const data = await response.json();
            const answer = data.answer || "Ä®vyko klaida.";

            typing.remove();
            addMessage(answer, "bot");

            firstMessage = false; // po pirmo atsakymo sveikinimas nebus rodomas
        } catch {
            typing.remove();
            addMessage("Ä®vyko klaida.", "bot");
        }
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
    });
</script>

</body>
</html>
